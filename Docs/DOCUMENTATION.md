# BloodChain

The code flow of the Dapp is as given below.


## Workflow....!


#### Doners workflow

1. As the user gets into the BloodChain he can see a home page where he can choose what to, that is whether he is a Hospital or a Doner. If he chooses Doner the he is routed to a search page with an inputbox for entering Hospitals id and another for entering the Doners id  and button which performs a search function.

2. In the main.js the Button trigers a function search which will then redirect to a '/listDoner' where the  did (Hospitals id) and sId(Doners Id ) is passed to getDonerList function(did,sid) in the Userclient.js.


3. In getDonerList function the first 6 characters of hash of Hospitals id and hash of search id is taken as the address and is passed to getState function to get the data from the chain.


4. '/listDoner' here we called an await function so the data fron the state is got here and then it is converted to base 64 and is converted to arry using .split(',') function. then it is passed to a list and then rendered it to an hbs table.


#### Hospitals workflow


1. When we click on the Hospital button then the site is redirected to a login page where the Hospital can enter their private key and if the  key is valid then the get loged to the dashboard. And a session of the private key is stored


2. In the dashboard there is two options for the Hospitals which is one to list the Doner details using thier id and the other is to add new Doner description or medical data to the chain.


3. When we click the add Doner details we will get a Doner form which is renderd from [index.js](http://localhost:3000//DonerForm) there you can see from with inputs, Hospitals private key is taken from the sessionStorage.getItem,  PatienId, Name ,Age, Sex, Address, Consulting Hospital, Constulting Hospital's, Observations, Disease, prescribed Medicine these data's are filled and the form is submitted.


4. When we click the add Doner details button then a function addDoners() is triggered in the main.js. The data is taken in main.js using [document.getElementById('id').value](). The data is then passed to the [index.js]() as in json format.


5. The data got from the ['/addDoners'] is then stored to variables from the body and is passed to the userclient using an instance or the object that is created of that class and the data is passed to [addDoner]() function of the userclient.


6. The data is received in the addDoner function there an address is generated by calling a [getDoneraddress]() function that is imported from the [transcation.js]() and the address is generated and the [createTransaction(FAMILY_NAME,[address],[address],Key,payload)]() is passed to another create Transaction function in the [processor.js]() from there the transaction is initialised and transcation headerBytes, transaction is created then is packed together to form bathches then the batches are then batches are grouped to list and is converted to batchlistbytes and transfered to an async function.


7. The batchlist is converted and send to an async function send transaction and from there the data is passed to the Transaction processor.



8. The data is passed to the apply function function the data is decoded and converted to array and is the passed to the external addDoner function in the TP.


9. In the addDoner the data is passed with an address generated from [transaction.js]() and then the data is passed with context,address,payload to the [writeTostore]() function. 


10. In the [writeToStore]() function the data is written to the state with the passed function.


11. There is other button delete when you click that butto we will get a page to enter the data of Hospitals id and Doners id so that the data of that particular Doner can be deleted from the chain on the the button click. An action [deletefun()] () is triggered in the main.js to perform the delete operation and a transaction is initiated to delete the data from the state.


12.  The arguments are passed to index.js ---> to userclient [delete()] () and from there the action is added with data and passed to the transaction processor userclient [delete()]() ---> TP apply() method from there it is redirected to delete wethod if the action in the payload is delete.


13. From the delete() method the data is deleted using the  [context.deleteState([address])] ()





## Codeflow



### UserClient


1. A class Doner is defined and in that a constructor is defined which accepts a key from the client side the is passed null from all other sections other than login in the login session key is accepted and checked for whether it is a valid key or not.


2. AddDoner is the other important function defined in the Doner class that accepts the values that are passed from the index.js and from a key and the id  that is passed from the index an address is generated using getDonerAddress function that is called from the transaction.js in the /lib folder and the data is stored to a payload and passed to createTranscation function with arguments familyname, inputaddress, output address , key, payload are passed(in our case input address and output address are the same). The createTransaction function is imported to the class from another processor.js file that is in the /lib folder. 



3. DeleteDoner is the other function that is in the Doner class. Here the function accepts three arguments that is an id , key, a Hospitals id these are the paameters that is used in the whole project to create the storage address. Here we need these parameters to create an address. The function actually does is delete data from the state for that the user have to submit a transaction to the validator to delete data. Here also the address and key and other values are passed to createTransaction function in the processor.js file in the lib folder. 


4. Async getState is the other function inside the class that takes address and returns  the data from the state to the function which it is called from in json format.


5. GetDonerList is the other async function that is used to get Doner treatment details to anyone with Hospitals id and the Doner. The function used the data to generate address of the stored data location and that address is passed to the getState function and they return the result back to the same. The function is called from Doner search page. 


6. GetDonerList1 is the other async function that is used to get Doner treatment details to Hospitals with their id they can get the list of Doners they have treated. The function used the data to generate address of the stored data location and that address is passed to the getState function and they return the result back to the same. The function is called from Hospitals search page. 



### TP


1. Class Doner that is extendeds transaction handler in the class there is a constructor with super, when the instance of the class is created the super is called that is a sawtooth sdk function. And the family name version and namespace are stored. The data from the processor.js is given to the apply method in the Doner class here the data is decode back to the normal form and then checks form the action value. If it is "Add" then the addDoner function is called if it is "Delete" the other delete function in the processor is called. 


2. AddDoner is the other function in the Doner which accepts the data and gets an address from the getDonerAddress and the Donerdetails are stored as a list and these values are passed to the WriteTostore function.


3. Delete function accepts the values and creates an address with Doner id Hospitals id and key and then using context.deleteState([address]) the data in the state is deleted.



### Processor


The processor.js is used in the project to give the project more modularised form. In the processor the only function it does is it initialises a transaction and with the variables which the client sends to the processor. It the creates a transaction, creates transactionheaderbytes, create transaction, makes transaction to lists, then these list are grouped to batches, batches are grouped to batchlists. And then the data is send to the validator using the rest-api using sendTransaction function.




### Transaction


Transaction processor is used to define some commonly used functions to group together.




1. Hash is a function used to get sha512 hash of a given character


2. modifyData is a function used to write data to state it accepts three values (context,address, message).


3. GetDonerAddress is a function used throughout the project the function is used to get the address for a storage location. 


